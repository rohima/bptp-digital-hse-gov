{% extends "layouts/main.html" %}

{% block pageTitle %}
Upload formulation file –{{serviceName}} – GOV.UK
{% endblock %}

{% block beforeContent %}
  <a class="govuk-back-link" href="javascript:window.history.back()">Back</a>
{% endblock %}

{% block content %}

<style>
  .govuk-summary-list__key {
    width:60%
  }
</style>

  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">

      {# <span class="govuk-caption-l">Documents</span> #}

      <div class="govuk-error-summary" data-module="govuk-error-summary">
        <div role="alert">
          <h2 class="govuk-error-summary__title">
            There is a problem
          </h2>
          <div class="govuk-error-summary__body">
            <ul class="govuk-list govuk-error-summary__list">
              <li>
                <a href="#">File format is wrong</a>
              </li>
              <li>
                <a href="#">File is not readable</a>
              </li>
              <li>
                <a href="#">Substance name [xxx] is not a registered substance</a>
              </li>
              <li>
                <a href="#">Co-formulant [xxx] must have at least one trade name</a>
              </li>
              <li>
                <a href="#">Weight concentration must be a number</a>
              </li>
              <li>
                <a href="#">The selected file must use the template</a>
              </li>
            </ul>
          </div>
        </div>
      </div>

      <h1 class="govuk-heading-l">
        Upload your formulation composition file
      </h1>

     
        <form class="form" method="post">

         <style>
          .govuk-summary-list__key {
            width:60%
          }
        </style>
<p>Use the <a href="#">CRD formulation composition template</a> (opens in a new tab) to enter your formulation details. Save the completed file in CSV format. </p>

{% from "govuk/components/details/macro.njk" import govukDetails %}

<details class="govuk-details" data-module="govuk-details">
  <summary class="govuk-details__summary">
    <span class="govuk-details__summary-text">
      Help with errors in your file
    </span>
  </summary>
  <div class="govuk-details__text">
    When you upload your file, the service will check the data and highlight any errors for you to fix. <br><br>If you need to fix errors, you must make the changes to your spreadsheet (.xlsx or .ods) file, save it in CSV format, and upload it again. 
  </div>
</details>
        
            {# <div id="file-upload-1-hint" class="govuk-hint">
              Save your file as a CSV, TSV, ODS, or Microsoft Excel spreadsheet. Each file must be a maximum of XGB.

            </div> #}
        
            <p id="upload-update" class="govuk-body govuk-!-display-none" aria-live="assertive" aria-relevant="all">1 of 2 files uploaded</p>
        
            
            <button id="upload-more" style="display:none" class="govuk-button govuk-button--secondary" data-module="govuk-button">
              Add more files
            </button>
            
            <div id="upload-wrapper" class="govuk-form-group">
              <label class="govuk-label" for="upload-button">
                Upload a file again
              </label>
              <input class="govuk-file-upload" id="upload-button" name="upload-button" type="file" multiple="multiple">
            </div>
        
            <p class="govuk-body govuk-!-display-none" id="refreshPageProgress"><a href="#" class="govuk-link">Refresh page to update file upload progress</a></p>
        
            <dl id="file-row-container" class="govuk-summary-list govuk-summary-list--long-key">
        
            </dl>


            {# <table class="govuk-table">
              <caption class="govuk-table__caption govuk-table__caption--m">[File.csv] preview</caption>
              <thead class="govuk-table__head">
                <tr class="govuk-table__row">
                  <th scope="col" class="govuk-table__header app-custom-class">Component</th>
                  <th scope="col" class="govuk-table__header app-custom-class">CAS no.</th>
                  <th scope="col" class="govuk-table__header app-custom-class">Trade name</th>
                  <th scope="col" class="govuk-table__header app-custom-class">Function</th>
                  <th scope="col" class="govuk-table__header app-custom-class">g/kg</th>
                  <th scope="col" class="govuk-table__header app-custom-class">% w/w</th>
                </tr>
              </thead>
              <tbody class="govuk-table__body">
                <tr class="govuk-table__row">
                  <th scope="row" class="govuk-table__header">Active substance</th>
                  <td class="govuk-table__cell">012-34567-89</td>
                  <td class="govuk-table__cell">activeiole</td>
                  <td class="govuk-table__cell">Insecticide</td>
                  <td class="govuk-table__cell">Pure 123, Technical 123</td>
                  <td class="govuk-table__cell">Pure 12.3, Technical 12.3</td>
                </tr>
                <tr class="govuk-table__row">
                  <th scope="row" class="govuk-table__header">Active substance</th>
                  <td class="govuk-table__cell">012-34567-89</td>
                  <td class="govuk-table__cell">activeiole</td>
                  <td class="govuk-table__cell">Insecticide</td>
                  <td class="govuk-table__cell">Pure 123, Technical 123</td>
                  <td class="govuk-table__cell">Pure 12.3, Technical 12.3</td>
                </tr>
                <tr class="govuk-table__row">
                  <th scope="row" class="govuk-table__header">Active substance</th>
                  <td class="govuk-table__cell">012-34567-89</td>
                  <td class="govuk-table__cell">activeiole</td>
                  <td class="govuk-table__cell">Insecticide</td>
                  <td class="govuk-table__cell">Pure 123, Technical 123</td>
                  <td class="govuk-table__cell">Pure 12.3, Technical 12.3</td>
                </tr>
                <tr class="govuk-table__row">
                  <th scope="row" class="govuk-table__header">Active substance</th>
                  <td class="govuk-table__cell">012-34567-89</td>
                  <td class="govuk-table__cell">activeiole</td>
                  <td class="govuk-table__cell">Insecticide</td>
                  <td class="govuk-table__cell">Pure 123, Technical 123</td>
                  <td class="govuk-table__cell">Pure 12.3, Technical 12.3</td>
                </tr>
                <tr class="govuk-table__row">
                  <th scope="row" class="govuk-table__header">Active substance</th>
                  <td class="govuk-table__cell">012-34567-89</td>
                  <td class="govuk-table__cell">activeiole</td>
                  <td class="govuk-table__cell">Insecticide</td>
                  <td class="govuk-table__cell">Pure 123, Technical 123</td>
                  <td class="govuk-table__cell">Pure 12.3, Technical 12.3</td>
                </tr>
              </tbody>
            </table> #}

            <p><a href="test-formula-type-add">Enter formulation manually</a></p>





        
                {{ govukButton({
                  text: "Save and continue"
                }) }}
        
                
        
              </form>
        
            </div>
          </div>
        
        {% endblock %}
        
        {% block pageScripts %}
        
        <script>
        document.getElementById("upload-button").addEventListener("click", fileUpload);
        document.getElementById("upload-more").addEventListener("click", showUploadButton);
        document.getElementById("upload-button").addEventListener("change", fileSelected);
        
        const fileRows = document.getElementById("file-row-container");
        const uploadUpdate = document.getElementById("upload-update");
        
        const myTimeout = setInterval(checkUploads, 1000);
        
        function checkUploads() {
          console.log("checking uploads")
          // check all the uploaded and review if any of them need updating
          var filesUploading = document.getElementsByClassName('govuk-tag--yellow')
        
          if (filesUploading.length > 0) {
            for (i = 0; i < filesUploading.length; i++) {
              console.log(filesUploading[i])
              // do a random check and see if the file is uploaded
              if (Math.floor(Math.random() * 3) == 2) {
                // change the label
                filesUploading[i].innerHTML = 'uploaded'
                filesUploading[i].classList.add('govuk-tag--green')
                filesUploading[i].classList.remove('govuk-tag--yellow')
              }
            }
          }
        
          filesUploading = document.getElementsByClassName('govuk-tag--yellow').length
          filesUploaded =document.getElementsByClassName('govuk-tag--green').length
        
          // uploadUpdate.textContent = `${filesUploaded} of ${filesUploading + filesUploaded} files uploaded`;
          // uploadUpdate.classList.remove("govuk-!-display-none");

          // old code ends

          // new code start
          uploadUpdate.textContent = `${filesUploaded} of ${filesUploading + filesUploaded} files uploaded`;
  if (filesUploaded > 0 || filesUploading > 0) {
    uploadUpdate.classList.remove("govuk-!-display-none");}
          // new code finish


        }
        
        
        
        function fileUpload() {
          //console.log("upload clicked")
        }
        
        function showUploadButton(e) {
          // remove the upload button and replace with an upload more button
            e.preventDefault()
            document.getElementById("upload-button").value = "";
            document.getElementById("upload-wrapper").style.display = "block";
            document.getElementById("upload-more").style.display = "none";
        }
        
        function fileSelected(e) {
        
          for (i = 0; i < e.target.files.length; i++) {
            
            const markup = `
              <dt class="govuk-summary-list__key">
                <a class="govuk-link" href="#">${e.target.files[i].name}</a>
                 <input type="hidden" id="filesUploaded" name="filesUploaded" value="${e.target.files[i].name}">
              </dt>
              <dd class="govuk-summary-list__value">
                <strong class="govuk-tag govuk-tag--yellow">uploading</strong>
              </dd>
              <dd class="govuk-summary-list__actions">
                <a class="govuk-link" href="#">
                  Remove<span class="govuk-visually-hidden"> ${e.target.files[i].name}</span>
                </a>
              </dd>
            `;
        
            // remove the upload button and replace with an upload more button
            document.getElementById("upload-wrapper").style.display = "none";
            document.getElementById("upload-more").style.display = "block";  
            
            let row = document.createElement('div');
            row.classList.add("govuk-summary-list__row")
            row.innerHTML = markup
            fileRows.append(row)
        
            filesUploading = document.getElementsByClassName('govuk-tag--yellow').length
            filesUploaded =document.getElementsByClassName('govuk-tag--green').length
        
            uploadUpdate.textContent = `${filesUploaded} of ${filesUploading} files uploaded`;
            uploadUpdate.classList.remove("govuk-!-display-none");
        
          }
        
        }
        </script>
        {% endblock %}